<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Sandcastle Defense mk1</title>
    <style type="text/css">
        #container {
            border: 1px solid silver;
            display: inline-block;
        }

        .row {
            height: 25px;
            margin: 0;
            padding: 0;
            clear: both;
        }
        
        .tile {
            width: 25px;
            height: 25px;
            box-sizing: border-box;
            text-align: center;
            display: inline-block;
            border: 0;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        
        .tile.wave {
            background-color: blue !important;
        }
        
        .tile:hover {
            background-color: #eee !important;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script type="text/javascript">
        /**
         * A tile on the game board
         * 
         * @param height
         * @constructor
         */
        function GameTile(height) {
            function _makeTile(gameTile) {
                var el = document.createElement('div');
                el.className = 'tile';

                el.addEventListener('click', function(e) {
                    gameTile.height += 5;
                    gameTile.render();
                });

                return el;
            }
            
            this.height = height;
            this.el = _makeTile(this);
        }
        
        GameTile.prototype.render = function() {
            this.el.style.backgroundColor = "#"+(255 - this.height).toString(16)+(255 - this.height).toString(16)+(255 - this.height).toString(16);
            
            return this;
        };
        
        function WaveGenerator(gameBoard, interval, maxHeight) {
            var self = this;
            gameBoard.on('tick', function() {
                self.tick();
            });
            
            this.gameBoard = gameBoard;
            this.interval  = interval;
            this.maxHeight = maxHeight;
            this.waves     = [];
            
            setInterval(function() {
                if (self.waves.length <= 0) {
                    self.waveOnNextTick = true;
                }
            }, interval * 1000);
        }
        
        WaveGenerator.prototype.tick = function() {
            var self = this;
            this.waves.slice(0).forEach(function(wave) {
                wave.tick();

                if (!wave.valid()) {
                    self.waves.splice(self.waves.indexOf(wave), 1);
                }
            });
            
            if (this.waveOnNextTick) {
                this.waveOnNextTick = false;
                
                var wave = new Wave(this.gameBoard, 2);
                wave.render();
                
                this.waves.push(wave);
            }
        };

        /**
         * A very simplistic wave
         * 
         * @param gameBoard
         * @param maxHeight
         * @constructor
         */
        function Wave(gameBoard, maxHeight) {
            this.gameBoard = gameBoard;
            this.maxHeight = maxHeight;
            this.waves = [];
            this.toMake = [];
            
            var rows = gameBoard.map.length;
            
            var initialX = this.gameBoard.map[0].length - 1;

            for (var i = 0; i < rows; i++) {
                this.make(initialX, i, this.maxHeight);
            } 
            
            for (var currentHeight = this.maxHeight - 1; currentHeight > 0; currentHeight--) {
                this.toMake.push({
                    x:      initialX,
                    height: currentHeight
                });
            }
        }
        
        Wave.prototype.make = function(x, y, height) {
            height = height || this.maxHeight;
            var tile = this.gameBoard.getTile(x, y);
            if (!tile) {
                return;
            }
            
            this.waves.push({
                x: x,
                y: y,
                height: height,
                tile: tile
            });
        };
        
        Wave.prototype.move = function(wave, newX, newY) {
            wave.tile.el.className = 'tile';
            
            var tile = this.gameBoard.getTile(newX, newY);
            if (!tile) {
                this.waves.splice(this.waves.indexOf(wave), 1);
                
                return false;
            }
            
            var waveHeight = wave.height;
            var tileHeight = tile.height;
            
            tile.height = tileHeight - waveHeight;
            if (tile.height < 0) {
                tile.height = 0;
            }
            
            tile.render();
                        
            wave.height = waveHeight - tileHeight;
            if (wave.height <= 0) {
                this.waves.splice(this.waves.indexOf(wave), 1);

                return false;
            }
            
            wave.x = newX;
            wave.y = newY;
            wave.tile = tile;
            
            return true;
        };
                
        Wave.prototype.render = function() {
            this.waves.slice(0).forEach(function(wave) {
                wave.tile.el.className = 'tile wave';
            });
            
            return this;
        };
        
        Wave.prototype.valid = function() {
            return this.waves.length > 0;
        };
        
        Wave.prototype.tick = function() {
            var self = this;
            var rows = this.gameBoard.map.length;
            this.waves.slice(0).forEach(function(wave) {
                self.move(wave, wave.x - 1, wave.y);
            });
            
            if (this.toMake.length > 0) {
                var info = this.toMake.shift();
                for (var y = 0; y < rows; y++) {
                    this.make(info.x, y, info.height);
                }
            }
            
            this.render();
        };

        /**
         * A game board
         * 
         * @param container
         * @param width
         * @param height
         * @constructor
         */
        function GameBoard(container, width, height) {
            this.container = container;
            this.wave = null;
            this.map = []; 
            this.listeners = {};
            
            for (var i = 0; i < height; i++) {
                var row = [];
                for (var j = 0; j < width; j++) {
                    row.push(new GameTile(0));
                }
                this.map.push(row);
            }
            
            var self = this;
            setInterval(function() {
                self.trigger('tick');
            }, 1000 / 10);
        }
        
        GameBoard.prototype.on = function(name, handler) {
            if (!this.listeners[name]) {
                this.listeners[name] = [];
            }
            
            this.listeners[name].push(handler);
        };
        
        GameBoard.prototype.trigger = function(name, args) {
            if (!this.listeners[name]) {
                return;
            }

            this.listeners[name].slice(0).forEach(function(handler) {
                handler(args);
            });
        };
        
        GameBoard.prototype.getRowCount = function() {
            return this.map.length;
        };

        GameBoard.prototype.getColumnCount = function() {
            return this.map[0].length;
        };
        
        GameBoard.prototype.getTile = function(x, y) {
            if (this.map[y] && this.map[y][x]) {
                return this.map[y][x];
            }
            
            return null;
        };
        
        GameBoard.prototype.render = function() {
            var container = this.container;
            container.innerHTML = '';
            this.map.forEach(function(row) {
                var rowEl = document.createElement('div');
                rowEl.className = 'row';
                row.forEach(function(gameTile) {
                    rowEl.appendChild(gameTile.render().el);
                });
                
                container.appendChild(rowEl);
            });
            
            if (this.wave) {
                this.wave.render();
            }
        };
        
        var board = new GameBoard(document.getElementById('container'), 30, 20);
        var generator = new WaveGenerator(board, 5, 5);
        
        board.render();
    </script>
</body>
</html>